# Edgeberry Device Hub â€” Mosquitto broker config
# Reference: https://mosquitto.org/man/mosquitto-conf-5.html

## Per-listener security settings
per_listener_settings true

## Listener (mTLS only; no passwords)
listener 8883 0.0.0.0
## Enforce mTLS for external clients
allow_anonymous false
require_certificate true
use_subject_as_username true

## TLS materials (absolute paths). Trust CA via capath so CA rotation is seamless
# capath is managed by edgeberry-ca-rehash.{path,service}
capath   /etc/mosquitto/certs/edgeberry-ca.d
certfile /etc/mosquitto/certs/server.crt
keyfile  /etc/mosquitto/certs/server.key

## Client certs are required; CN maps to username for ACLs

## ACLs for TLS listener (absolute path)
acl_file /etc/mosquitto/acl.d/edgeberry.acl

## Local non-TLS listener for internal services only (anonymous, unrestricted)
listener 1883 127.0.0.1
allow_anonymous true


# Logging
log_dest stdout
log_dest topic
log_type all
connection_messages true
log_timestamp true

# Publish $SYS hierarchy updates every 10s (broker stats and, with log_dest topic, logs)
sys_interval 10


