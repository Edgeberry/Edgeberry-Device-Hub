# Edgeberry Device Hub â€” Mosquitto broker config
# Reference: https://mosquitto.org/man/mosquitto-conf-5.html

## Per-listener security settings
per_listener_settings true

## Listener (mTLS only; no passwords)
listener 8883 0.0.0.0
## Enforce mTLS for external clients
allow_anonymous false
require_certificate true
use_subject_as_username true

## TLS materials (absolute paths). Trust CA via capath so CA rotation is seamless
# capath is managed by edgeberry-ca-rehash.{path,service}
capath   /etc/mosquitto/certs/edgeberry-ca.d
certfile /opt/Edgeberry/devicehub/config/certs/server.crt
keyfile  /opt/Edgeberry/devicehub/config/certs/server.key

## Client certs are required; CN maps to username for ACLs

## ACLs for TLS listener (absolute path)
acl_file /opt/Edgeberry/devicehub/config/mosquitto.acl

## Local non-TLS listener for internal services only (anonymous, unrestricted)
listener 1883 127.0.0.1
allow_anonymous true
# Permissive ACL for localhost listener only (absolute path)
acl_file /opt/Edgeberry/devicehub/config/mosquitto-local-unrestricted.acl

# Persistence
persistence true
persistence_location /mosquitto/data/

# Logging
log_dest stdout
log_type information
connection_messages true

# No message size limit (0 means unlimited); tune for production
max_packet_size 0

