# Edgeberry Device Hub â€” Mosquitto PROD config (mTLS)
# Usage (system install): copy to /etc/mosquitto/conf.d/devicehub.conf and restart mosquitto
# Ref: https://mosquitto.org/man/mosquitto-conf-5.html

# Use per-listener security so TLS and local auth differ per port
per_listener_settings true

# Secure listener with TLS + client certs (mTLS)
listener 8883 0.0.0.0
allow_anonymous false

# TLS (adjust paths to your install)
cafile /etc/mosquitto/certs/ca.crt
certfile /etc/mosquitto/certs/server.crt
keyfile /etc/mosquitto/certs/server.key
# Optional: use CRL to revoke client certs
# crlfile /etc/mosquitto/certs/ca.crl

# Require and verify client certificates
require_certificate true
use_identity_as_username false
# Map certificate subject CN (or full subject) to username for ACLs
# Options: use_subject_as_username true | use_identity_as_username true
# We use subject CN so devices can be keyed by deviceId in the cert CN
use_subject_as_username true

# ACLs for TLS listener
acl_file /etc/mosquitto/aclfile

# Local non-TLS listener for same-host services only (anonymous, unrestricted)
# - Loopback bind only
# - No TLS, no username/password
listener 1883 127.0.0.1
allow_anonymous true
# Permissive ACL for localhost listener only
acl_file /etc/mosquitto/acl.d/edgeberry-local-unrestricted.acl

# Persistence
persistence true
persistence_location /var/lib/mosquitto/

# Logging
log_dest syslog
log_dest stdout
log_type notice
connection_messages true

# Limits
max_inflight_messages 50
# 0 = unlimited; tune for your environment
message_size_limit 0

# Protocol tweaks helpful in IoT environments
allow_zero_length_clientid false
persistent_client_expiration 1m
check_retain_source true

